const alpha3ToAlpha2 = {
    AFG: "AF",
    ALA: "AX",
    ALB: "AL",
    DZA: "DZ",
    ASM: "AS",
    AND: "AD",
    AGO: "AO",
    AIA: "AI",
    ATA: "AQ",
    ATG: "AG",
    ARG: "AR",
    ARM: "AM",
    ABW: "AW",
    AUS: "AU",
    AUT: "AT",
    AZE: "AZ",
    BHS: "BS",
    BHR: "BH",
    BGD: "BD",
    BRB: "BB",
    BLR: "BY",
    BEL: "BE",
    BLZ: "BZ",
    BEN: "BJ",
    BMU: "BM",
    BTN: "BT",
    BOL: "BO",
    BES: "BQ",
    BIH: "BA",
    BWA: "BW",
    BVT: "BV",
    BRA: "BR",
    VGB: "VG",
    IOT: "IO",
    BRN: "BN",
    BGR: "BG",
    BFA: "BF",
    BDI: "BI",
    KHM: "KH",
    CMR: "CM",
    CAN: "CA",
    CPV: "CV",
    CYM: "KY",
    CAF: "CF",
    TCD: "TD",
    CHL: "CL",
    CHN: "CN",
    HKG: "HK",
    MAC: "MO",
    CXR: "CX",
    CCK: "CC",
    COL: "CO",
    COM: "KM",
    COG: "CG",
    COD: "CD",
    COK: "CK",
    CRI: "CR",
    CIV: "CI",
    HRV: "HR",
    CUB: "CU",
    CUW: "CW",
    CYP: "CY",
    CZE: "CZ",
    DNK: "DK",
    DJI: "DJ",
    DMA: "DM",
    DOM: "DO",
    ECU: "EC",
    EGY: "EG",
    SLV: "SV",
    GNQ: "GQ",
    ERI: "ER",
    EST: "EE",
    ETH: "ET",
    FLK: "FK",
    FRO: "FO",
    FJI: "FJ",
    FIN: "FI",
    FRA: "FR",
    GUF: "GF",
    PYF: "PF",
    ATF: "TF",
    GAB: "GA",
    GMB: "GM",
    GEO: "GE",
    DEU: "DE",
    GHA: "GH",
    GIB: "GI",
    GRC: "GR",
    GRL: "GL",
    GRD: "GD",
    GLP: "GP",
    GUM: "GU",
    GTM: "GT",
    GGY: "GG",
    GIN: "GN",
    GNB: "GW",
    GUY: "GY",
    HTI: "HT",
    HMD: "HM",
    VAT: "VA",
    HND: "HN",
    HUN: "HU",
    ISL: "IS",
    IND: "IN",
    IDN: "ID",
    IRN: "IR",
    IRQ: "IQ",
    IRL: "IE",
    IMN: "IM",
    HEB: "IL",
    ITA: "IT",
    JAM: "JM",
    JPN: "JP",
    JEY: "JE",
    JOR: "JO",
    KAZ: "KZ",
    KEN: "KE",
    KIR: "KI",
    PRK: "KP",
    KOR: "KR",
    KWT: "KW",
    KGZ: "KG",
    LAO: "LA",
    LVA: "LV",
    LBN: "LB",
    LSO: "LS",
    LBR: "LR",
    LBY: "LY",
    LIE: "LI",
    LTU: "LT",
    LUX: "LU",
    MKD: "MK",
    MDG: "MG",
    MWI: "MW",
    MYS: "MY",
    MDV: "MV",
    MLI: "ML",
    MLT: "MT",
    MHL: "MH",
    MTQ: "MQ",
    MRT: "MR",
    MUS: "MU",
    MYT: "YT",
    MEX: "MX",
    FSM: "FM",
    MDA: "MD",
    MCO: "MC",
    MNG: "MN",
    MNE: "ME",
    MSR: "MS",
    MAR: "MA",
    MOZ: "MZ",
    MMR: "MM",
    NAM: "NA",
    NRU: "NR",
    NPL: "NP",
    NLD: "NL",
    ANT: "AN",
    NCL: "NC",
    NZL: "NZ",
    NIC: "NI",
    NER: "NE",
    NGA: "NG",
    NIU: "NU",
    NFK: "NF",
    MNP: "MP",
    NOR: "NO",
    OMN: "OM",
    PAK: "PK",
    PLW: "PW",
    PSE: "PS",
    PAN: "PA",
    PNG: "PG",
    PRY: "PY",
    PER: "PE",
    PHL: "PH",
    PCN: "PN",
    POL: "PL",
    POR: "PT",
    PRI: "PR",
    QAT: "QA",
    REU: "RE",
    ROU: "RO",
    RUS: "RU",
    RWA: "RW",
    BLM: "BL",
    SHN: "SH",
    KNA: "KN",
    LCA: "LC",
    MAF: "MF",
    SPM: "PM",
    VCT: "VC",
    WSM: "WS",
    SMR: "SM",
    STP: "ST",
    SAU: "SA",
    SEN: "SN",
    SRB: "RS",
    SYC: "SC",
    SLE: "SL",
    SGP: "SG",
    SXM: "SX",
    SVK: "SK",
    SVN: "SI",
    SLB: "SB",
    SOM: "SO",
    ZAF: "ZA",
    SGS: "GS",
    SSD: "SS",
    SPA: "ES",
    LKA: "LK",
    SDN: "SD",
    SUR: "SR",
    SJM: "SJ",
    SWZ: "SZ",
    SWE: "SE",
    CHE: "CH",
    SYR: "SY",
    TWN: "TW",
    TJK: "TJ",
    TZA: "TZ",
    THA: "TH",
    TLS: "TL",
    TGO: "TG",
    TKL: "TK",
    TON: "TO",
    TTO: "TT",
    TUN: "TN",
    TUR: "TR",
    TKM: "TM",
    TCA: "TC",
    TUV: "TV",
    UGA: "UG",
    UKR: "UA",
    ARE: "AE",
    GBR: "GB",
    USA: "US",
    UMI: "UM",
    URY: "UY",
    UZB: "UZ",
    VUT: "VU",
    VEN: "VE",
    VNM: "VN",
    VIR: "VI",
    WLF: "WF",
    ESH: "EH",
    YEM: "YE",
    ZMB: "ZM",
    ZWE: "ZW",
    XKX: "XK"
};
const apiURL = 'https://tatoeba.org/';

const flip = (data) => Object.fromEntries(
    Object
        .entries(data)
        .map(([key, value]) => [value, key])
);
const alpha2ToAlpha3 = flip(alpha3ToAlpha2);

document.addEventListener('DOMContentLoaded', function() {
    browser.permissions.contains({ origins: [apiURL] }).then(function(hasPermission) {
        if(!hasPermission) {
            document.getElementById('permissionPopup').style.display = 'block';
            document.getElementById('main').style.display = 'none';
        }
    });
    document.getElementById('grantPermission').addEventListener('click', function() {
        browser.permissions.request({ origins: [apiURL] });
        location.reload();
    });
    document.getElementById('source').addEventListener('change', function() {
        chrome.storage.local.set({ 'sourceLang': source.value });
        update();
    });
    document.getElementById('target').addEventListener('change', function() {
        chrome.storage.local.set({ 'targetLang': target.value });
        update();
    });

    chrome.storage.local.get('sourceLang', function(result) {
        source.value = result.sourceLang ?? '';
        chrome.storage.local.get('targetLang', function(result) {
            target.value = result.targetLang ?? '';
            update();
        });
    });
});
function getFlagEmoji(countryCode) {
    switch (countryCode) {
        case 'tok':
            return '<img src="img/tok.svg" width="20" height="20">'
        case 'epo':
            return '<img src="img/epo.svg" width="20" height="20">'
    }
    if (alpha3ToAlpha2[countryCode.toUpperCase()]) {
        countryCode = alpha3ToAlpha2[countryCode.toUpperCase()];
    }
    else if (countryCode == 'eng') {
        countryCode = 'gb';
    } else {
        return `[${countryCode}]`;
    }
    const codePoints = countryCode
        .toUpperCase()
        .split('')
        .map(char => 127397 + char.charCodeAt());
    return String.fromCodePoint(...codePoints);
}

function fetchDefinition(word, sourceLang, targetLang, response) {
    const url = `${apiURL}/eng/api_v0/search?from=${sourceLang}&trans_filter=limit&query=${word}&sort=created&trans_to=${targetLang}&to=${targetLang}`;
    fetch(url).then(r => r.json().then(j=>response(j))).catch((e) => {
        throw e;
    });
}
function update() {
    chrome.tabs.query({ active: true, currentWindow: true }, function(tabs) {
        chrome.scripting.executeScript({
            target: { tabId: tabs[0].id },
            func: function() {
                return window.getSelection().toString();
            }
        }, function(selection) {
            let word = selection[0].result;
            const sourceLang = source.options[source.selectedIndex].value;
            const targetLang = target.options[target.selectedIndex].value;

            if (word) {
                document.getElementById('definition').innerHTML = '<div class="loader"></div>';
                document.getElementById('tatoeba-link-wrapper').innerHTML = '';
                fetchDefinition(word, sourceLang, targetLang, function(response) {
                        document.getElementById('definition').innerHTML = '';
                        console.log(response);
                        if (response?.results?.length == 0) {
                            document.getElementById('definition').innerHTML = `
                                <p class='err'>Word not found</p>
                            `
                            return;
                        }
                        if(response === undefined) {
                                document.getElementById('definition').innerHTML = `
                                    <p class='err'>Error fetching definition</p>
                                `;
                                return;
                        }
                        document.getElementById('tatoeba-link-wrapper').innerHTML = `
                            <a class='view-on-website' href='https://tatoeba.org/en/sentences/search?from=${sourceLang}&query=${word}&to=${targetLang}'>View on Tatoeba</a>
                        `;
                        for (const result of response.results) {
                            if (result) {
                                const translation = (result?.translations?.find(t => t[0] !== undefined) ?? [])[0];
                                document.getElementById('definition').innerHTML += `
                                <div class='result'>
                                    <i class='sentence'><span class='flag'>${getFlagEmoji(result.lang)}</span>${result.text.replace(new RegExp(`(${word})`, 'gi'), '<b>$1</b>')}</i>
                                `;
                                if (translation) {
                                    document.getElementById('definition').innerHTML += `
                                    <p class='translation'><span class='flag'>${getFlagEmoji(translation.lang)}</span>${translation.text}</p>
                                    `;
                                }
                                else {
                                    document.getElementById('definition').innerHTML += `
                                    <p class='translation'></p>
                                    `;
                                    }
                                document.getElementById('definition').innerHTML += `
                                    </div>
                                `;
                            }
                        }
                    }
                );
            } else {
                document.getElementById('definition').innerHTML = `
                    <p class='err'>No word selected</p>
                `;
            }
        });
    });
}

